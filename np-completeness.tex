In order to show NP-completeness of our problem we will perform
reduction from 3-SAT. Let's take any formula $\Phi$ in 3-CNF. First,
transform $\Phi$ to equivalent formula $\Psi$ the following way:

\begin{itemize}
\item let's assign every clause its unique number from 1 to number of
  clauses
\item for every occurence of variable $v$ we replace it with variable named $v_{number
    of clauses}$
\item for every variable $v$ we add set of clauses in form $v_i \iff v_{i+1}$
\end{itemize}

Let's construct our tree out of gadgets for every variable connected
to tree root. The gadget is constructed as follows:

\begin{itemize}
\item i-th occurence of $v$ we create two leaves labeled $v_i$ and
  $\neg v_i$
\item we connect positive leaves in one subtree with root vertex called ``positive'' and negative leaves in
  another subtree with root vertex called ``negative''
\item we connect ``positive'' and ``negative'' into one subtree with
  root vertex called $v$
\item we set bandwidth constraints between $v_i$ and ``positive'' to
  $vms - 1$
\item we set bandwidth constraints between $\neg v_i$ and ``negative''
  to $vms - 1$
\item we set bandwidth constraints between ``negative'' and $v$ to
  $vms - \binom{number of occurences of v}{2}$
\item we set bandwidth constraints between ``positive'' and $v$ to
  $vms - \binom{number of occurences of v}{2}$
\item we set bandwidth constraints between $v$ and root to
  $vms - \binom{number of occurences of v}{2}$
\end{itemize}

For each clause we place 3 chunks in 3 leaves labeled as literals in
this clause.

We set number of virtual machines to place to be $3 \cdot number of
clauses$.

We set chunk transfer cost to be any positive integer, let's say 1.
We set VM communication transfer cost to be 1.

Let's define $C$ as VM communication cost when all machines are placed in leaves with labels of
positive literals.

This ends our construction.

To prove our reduction we need to decide $\Phi$ using solution to $VC$ instance described above. We do it the
following way:

\begin{itemize}
\item if there is no solution that doesn't exceed bandwidth, we
  answer: $\Phi$ is unsatisfiable
\item if minimal solution has value larger than $C$, we answer: $\Phi$
  is unsatisfiable
\item if minimal solution has value $C$, we answer: $\Phi$ is satisfiable
\end{itemize}

Proof of correctness.

First, we will proove that if $\Phi$ is satisfiable then our $VC$
instance has solution with cost equal to $C$. Let's take any valuation $F$
that satisfies $\Phi$. For every variable $v$ that is set to true we
place virtual machines in every vertex with label $v_i$. For every
variable $v$ that is set to false we place virtual machines in every
vertex with label $\neg v_i$. For every virtual machine we either have
a chunk in the same vertex - then we match the VM with the chunk - or
we do not have a chunk in the same vertex - then we do not match the
VM with any chunk. We need to proove two claims:
\begin{itemize}
\item This placement of virtual machines does not exceed the bandwidth
\item This placement of virtual machines matches every chunk
\end{itemize}

TODO: prove claims above.

Second, we will proove that if our VC instance has solution with cost
equal to $C$ than $\Phi$ is satisifiable. Let's create valuation $F$
in the following way:

\begin{itemize}
\item if $v_1$ has machine in it then $F(v) = true$
\item otherwise $F(v) = false$
\end{itemize}

In order to prove that $F$ satisfies $\Phi$ we will need to proove
following claim. If $v_1$ has virtual machine then for all $i$ we have
that $v_i$ has virtual machine and for all $i$ we have that $\neg v_i$
does not have a virtual machine. Also, if $\neg v_1$ has virtual
machine then for all $i$ we have that $\neg v_i$ has virtual machine
in it and for all $i$ we have that $v_i$ does not have a virtual
machine. 

\begin{proof}
By rules of bandwidth, we know that there is at most $\# leaves(G_i) / 2$ number of virtual
machines in every gadget. We ordered placement of exactly
$\# leaves(T) / 2$ VMs. So lower and upper bounds are equal. What is
footprint-optimal way of placing $\# leaves(G_i) / 2$ VMs in the gadget?
First, we notice that we can ommit chunk transfer cost, because by
bandwidth constraints we disallow any incoming traffic other than
communication cost with rest of VMs. We need to take under
consideration two parts of communication cost:
\begin{itemize}
\item communication among VMs inside the gadget
\item communication from VMs from the gadget to VMs outside of the gadget
\end{itemize}

We notice that (2) does not depend on placements of VMs within the
gadget.

Communication among VMs inside the gadget is lowest when all of them
are placed either in ``positive'' or all of them are placed in
``negative'' subtrees. There are several ways to prove this claim.
Here we will consider, what happens if we move VM from less saturated
subtree to more saturated subtree. We also need to compare the cost of
balanced placement ($\# leaves(G_i)/4$ VMs in both branches. 
\end{proof}
